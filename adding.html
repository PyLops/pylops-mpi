

<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    
        <title>Implementing new operators &#8212; PyLops-MPI</title>
    

  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="_static/style.css?v=e5b2244c" />
    <link rel="stylesheet" type="text/css" href="_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css?v=e45f66c9" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'adding';</script>
    <link rel="icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Contributing" href="contributing.html" />
    <link rel="prev" title="Post Stack Inversion - 3D" href="tutorials/poststack.html" />
    
    <script src="_static/require.js"></script>

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/pylopsmpi_b.png" class="logo__image only-light" alt="PyLops-MPI - Home"/>
    <img src="_static/pylopsmpi.png" class="logo__image only-dark pst-js-only" alt="PyLops-MPI - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="index.html">
    Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="gpu.html">
    GPU Support
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="api/index.html">
    PyLops MPI API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="gallery/index.html">
    Gallery
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="tutorials/index.html">
    Tutorials
  </a>
</li>


<li class=" current active">
  <a class="nav-link dropdown-item nav-internal" href="#">
    Implementing new operators
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="contributing.html">
    Contributing
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="changelog.html">
    Changelog
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="credits.html">
    Credits
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="index.html">
    Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="gpu.html">
    GPU Support
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="api/index.html">
    PyLops MPI API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="gallery/index.html">
    Gallery
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Implementing new operators
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="contributing.html">
    Contributing
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="changelog.html">
    Changelog
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="credits.html">
    Credits
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"></div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Implementing new operators</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="implementing-new-operators">
<span id="addingoperator"></span><h1>Implementing new operators<a class="headerlink" href="#implementing-new-operators" title="Link to this heading">#</a></h1>
<p>Users are welcome to create new operators and add them to the PyLops-MPI library.</p>
<p>In this tutorial, we will go through the key steps in the definition of an operator, using the
<a class="reference internal" href="api/generated/pylops_mpi.basicoperators.MPIBlockDiag.html#pylops_mpi.basicoperators.MPIBlockDiag" title="pylops_mpi.basicoperators.MPIBlockDiag"><code class="xref py py-class docutils literal notranslate"><span class="pre">pylops_mpi.basicoperators.MPIBlockDiag</span></code></a> as an example. This operator creates a block-diagonal matrix of
N pylops linear operators.</p>
<section id="creating-the-operator">
<h2>Creating the operator<a class="headerlink" href="#creating-the-operator" title="Link to this heading">#</a></h2>
<p>The first thing we need to do is to create a new file with the name of the operator we would like to implement.
Note that as the operator will be a class, we need to follow the UpperCaseCamelCase convention both for the class itself
and for the filename. It’s recommended to prefix the class name with <code class="docutils literal notranslate"><span class="pre">MPI</span></code> to distinguish it as an MPI Operator.</p>
<p>Once we have created the file, we will start by importing the modules that will be needed by the operator.
While this varies from operator to operator, you will always need to import the <a class="reference internal" href="api/generated/pylops_mpi.DistributedArray.html#pylops_mpi.DistributedArray" title="pylops_mpi.DistributedArray"><code class="xref py py-class docutils literal notranslate"><span class="pre">pylops_mpi.DistributedArray</span></code></a> class
which we use in this library as an alternative to the NumPy arrays. This class allows you to work with distributed arrays that
are partitioned/broadcasted across different ranks or processes in a parallel computing environment. Additionally, you will
need to import the <a class="reference internal" href="api/generated/pylops_mpi.MPILinearOperator.html#pylops_mpi.MPILinearOperator" title="pylops_mpi.MPILinearOperator"><code class="xref py py-class docutils literal notranslate"><span class="pre">pylops_mpi.MPILinearOperator</span></code></a> class, which serves as the <strong>parent</strong> class for any of our operators:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylops_mpi</span> <span class="kn">import</span> <span class="n">DistributedArray</span><span class="p">,</span> <span class="n">MPILinearOperator</span>
</pre></div>
</div>
<p>After that we define our new operator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MPIBlockDiag</span><span class="p">(</span><span class="n">MPILinearOperator</span><span class="p">):</span>
</pre></div>
</div>
<p>followed by a <a class="reference external" href="https://numpydoc.readthedocs.io/en/latest/format.html">numpydoc docstring</a>
(starting with <code class="docutils literal notranslate"><span class="pre">r&quot;&quot;&quot;</span></code> and ending with <code class="docutils literal notranslate"><span class="pre">&quot;&quot;&quot;</span></code>) containing the documentation of the operator. Such docstring should
contain at least a short description of the operator, a <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> section with a detailed description of the
input parameters and a <code class="docutils literal notranslate"><span class="pre">Notes</span></code> section providing a mathematical explanation of the operator. Take a look at
some of the core operators of PyLops-MPI to get a feeling of the level of details of the mathematical explanation.</p>
<section id="initialization-init">
<h3>Initialization (<code class="docutils literal notranslate"><span class="pre">__init__</span></code>)<a class="headerlink" href="#initialization-init" title="Link to this heading">#</a></h3>
<p>We then need to create the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> where the input parameters are passed and saved as members of our class.
While the input parameters change from operator to operator, it is always required to create three members, the first
called <code class="docutils literal notranslate"><span class="pre">shape</span></code> with a tuple containing the dimensions of the operator in the data and model space, the second
called <code class="docutils literal notranslate"><span class="pre">dtype</span></code> with the data type object (<code class="xref py py-obj docutils literal notranslate"><span class="pre">np.dtype</span></code>) of the model and data, and the third called <code class="docutils literal notranslate"><span class="pre">base_comm</span></code>
with an MPI base communicator (<a class="reference external" href="https://mpi4py.readthedocs.io/en/stable/reference/mpi4py.MPI.Comm.html#mpi4py.MPI.Comm" title="(in MPI for Python v4.0)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">mpi4py.MPI.Comm</span></code></a>, default set to <a class="reference external" href="https://mpi4py.readthedocs.io/en/stable/reference/mpi4py.MPI.COMM_WORLD.html#mpi4py.MPI.COMM_WORLD" title="(in MPI for Python v4.0)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">mpi4py.MPI.COMM_WORLD</span></code></a>) responsible for
communicating between different processes. In the context of MPIBlockDiag, we calculate the <code class="docutils literal notranslate"><span class="pre">shape</span></code> by performing
a sum-reduction on the shapes of each operator. If the <code class="docutils literal notranslate"><span class="pre">dtype</span></code> is not provided, it is determined from the operators,
while the <code class="docutils literal notranslate"><span class="pre">base_comm</span></code> is set to <code class="docutils literal notranslate"><span class="pre">MPI.COMM_WORLD</span></code> if not provided.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">LinearOperator</span><span class="p">],</span>
             <span class="n">base_comm</span><span class="p">:</span> <span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span>
             <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DTypeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span>
    <span class="n">mops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">nops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iop</span><span class="p">,</span> <span class="n">oper</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">):</span>
        <span class="n">nops</span><span class="p">[</span><span class="n">iop</span><span class="p">]</span> <span class="o">=</span> <span class="n">oper</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mops</span><span class="p">[</span><span class="n">iop</span><span class="p">]</span> <span class="o">=</span> <span class="n">oper</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mops</span> <span class="o">=</span> <span class="n">mops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nops</span> <span class="o">=</span> <span class="n">nops</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nops</span><span class="p">),</span> <span class="n">base_comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mops</span><span class="p">))</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">_get_dtype</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">base_comm</span><span class="o">=</span><span class="n">base_comm</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="forward-mode-matvec">
<h3>Forward mode (<code class="docutils literal notranslate"><span class="pre">_matvec</span></code>)<a class="headerlink" href="#forward-mode-matvec" title="Link to this heading">#</a></h3>
<p>We can then move onto writing the <em>forward mode</em> in the method <code class="docutils literal notranslate"><span class="pre">_matvec</span></code>. In other words, we will need to write
the piece of code that will implement the following operation <span class="math notranslate nohighlight">\(\mathbf{y} = \mathbf{A}\mathbf{x}\)</span>.
Such method is always composed of two inputs (the object itself <code class="docutils literal notranslate"><span class="pre">self</span></code> and the input model  <code class="docutils literal notranslate"><span class="pre">x</span></code>).
Here, both the input model <code class="docutils literal notranslate"><span class="pre">x</span></code> and input data <code class="docutils literal notranslate"><span class="pre">y</span></code> are instances of <a class="reference internal" href="api/generated/pylops_mpi.DistributedArray.html#pylops_mpi.DistributedArray" title="pylops_mpi.DistributedArray"><code class="xref py py-class docutils literal notranslate"><span class="pre">pylops_mpi.DistributedArray</span></code></a>.
In the case of MPIBlockDiag, each set of operators performs a matrix-vector product in forward mode,
and the final result is collected in a DistributedArray.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">DistributedArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DistributedArray</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">DistributedArray</span><span class="p">(</span><span class="n">global_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">local_shapes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_shapes_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iop</span><span class="p">,</span> <span class="n">oper</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">):</span>
        <span class="n">y1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oper</span><span class="o">.</span><span class="n">matvec</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">local_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mmops</span><span class="p">[</span><span class="n">iop</span><span class="p">]:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">mmops</span><span class="p">[</span><span class="n">iop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]))</span>
    <span class="n">y</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</pre></div>
</div>
</section>
<section id="adjoint-mode-rmatvec">
<h3>Adjoint mode (<code class="docutils literal notranslate"><span class="pre">_rmatvec</span></code>)<a class="headerlink" href="#adjoint-mode-rmatvec" title="Link to this heading">#</a></h3>
<p>Finally we need to implement the <em>adjoint mode</em> in the method <code class="docutils literal notranslate"><span class="pre">_rmatvec</span></code>. In other words, we will need to write
the piece of code that will implement the following operation <span class="math notranslate nohighlight">\(\mathbf{x} = \mathbf{A}^H\mathbf{y}\)</span>.
Such method is also composed of two inputs (the object itself <code class="docutils literal notranslate"><span class="pre">self</span></code> and the input data <code class="docutils literal notranslate"><span class="pre">y</span></code>).
Similar to <code class="docutils literal notranslate"><span class="pre">_matvec</span></code>, both the input model <code class="docutils literal notranslate"><span class="pre">x</span></code> and input data <code class="docutils literal notranslate"><span class="pre">y</span></code> are instances of <a class="reference internal" href="api/generated/pylops_mpi.DistributedArray.html#pylops_mpi.DistributedArray" title="pylops_mpi.DistributedArray"><code class="xref py py-class docutils literal notranslate"><span class="pre">pylops_mpi.DistributedArray</span></code></a>.
In the case of MPIBlockDiag, each set of operators performs a matrix-vector product in adjoint mode,
and the final result is collected in a DistributedArray.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_rmatvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">DistributedArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DistributedArray</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">DistributedArray</span><span class="p">(</span><span class="n">global_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">local_shapes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_shapes_m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iop</span><span class="p">,</span> <span class="n">oper</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">):</span>
        <span class="n">y1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oper</span><span class="o">.</span><span class="n">rmatvec</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">local_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nnops</span><span class="p">[</span><span class="n">iop</span><span class="p">]:</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">nnops</span><span class="p">[</span><span class="n">iop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]))</span>
    <span class="n">y</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</pre></div>
</div>
<p>And that’s it, we have implemented our first MPI Linear Operator!</p>
</section>
</section>
<section id="testing-the-operator">
<h2>Testing the operator<a class="headerlink" href="#testing-the-operator" title="Link to this heading">#</a></h2>
<p>Being able to write an operator is not yet a guarantee of the fact that the operator is correct, or in other words
that the adjoint code is actually the <em>adjoint</em> of the forward code.
We add tests for the operator by creating a new test within an existing/new <code class="docutils literal notranslate"><span class="pre">test_*.py</span></code> file in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> folder.</p>
<p>Generally a test file will start with a number of dictionaries containing different parameters we would like to
use in the testing of one or more operators. The test itself starts with two <strong>decorators</strong>. The first <strong>decorator</strong> indicates
that the tests need to be run with MPI processes, with a <code class="docutils literal notranslate"><span class="pre">min_size</span></code> of 2. The second <strong>decorator</strong> contains a list of all
(or some) of the dictionaries that will be used for our specific operator, which is followed by the definition of the
test.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">mpi</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;par&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">par1</span><span class="p">),</span> <span class="p">(</span><span class="n">par2</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_blockdiag</span><span class="p">(</span><span class="n">par</span><span class="p">):</span>
</pre></div>
</div>
<p>After this, you can write your test for the operator inside this method. We recommend using the <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_allclose.html#numpy.testing.assert_allclose" title="(in NumPy v2.1)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.testing.assert_allclose</span></code></a>
function with an <code class="docutils literal notranslate"><span class="pre">rtol=1e-14</span></code> to check the functionality of the operator. For assistance, you can refer to other test files
in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> folder.</p>
</section>
<section id="documenting-the-operator">
<h2>Documenting the operator<a class="headerlink" href="#documenting-the-operator" title="Link to this heading">#</a></h2>
<p>Once the operator has been created, we can add it to the documentation of PyLops-MPI. To do so, simply add the name of
the operator within the <code class="docutils literal notranslate"><span class="pre">index.rst</span></code> file in <code class="docutils literal notranslate"><span class="pre">docs/source/api</span></code> directory.</p>
<p>Moreover, in order to facilitate the user of your operator by other users, a simple example should be provided as part of the
Sphinx-gallery of the documentation of the PyLops-MPI library. The directory <code class="docutils literal notranslate"><span class="pre">examples</span></code> contains several scripts that
can be used as template.</p>
</section>
<section id="final-checklist">
<h2>Final checklist<a class="headerlink" href="#final-checklist" title="Link to this heading">#</a></h2>
<p>Before submitting your new operator for review, use the following <strong>checklist</strong> to ensure that your code
adheres to the guidelines of PyLops-MPI:</p>
<ul class="simple">
<li><p>you have created a new file containing a single class (or a function when the new operator is a simple combination of
existing operators and added to a new or existing directory within the <code class="docutils literal notranslate"><span class="pre">pylops_mpi</span></code> package.</p></li>
<li><p>the new class contains at least <code class="docutils literal notranslate"><span class="pre">__init__</span></code>, <code class="docutils literal notranslate"><span class="pre">_matvec</span></code> and <code class="docutils literal notranslate"><span class="pre">_rmatvec</span></code> methods.</p></li>
<li><p>the new class (or function) has a <a class="reference external" href="https://numpydoc.readthedocs.io/">numpydoc docstring</a> documenting
at least the input <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> and with a <code class="docutils literal notranslate"><span class="pre">Notes</span></code> section providing a mathematical explanation of the operator.</p></li>
<li><p>a new test has been added to an existing <code class="docutils literal notranslate"><span class="pre">test_*.py</span></code> file within the <code class="docutils literal notranslate"><span class="pre">tests</span></code> folder. Moreover it is advisable to
create a small toy example where the operator is applied in forward mode.</p></li>
<li><p>the new operator is used within at least one <em>example</em> (in <code class="docutils literal notranslate"><span class="pre">examples</span></code> directory) or one <em>tutorial</em>
(in <code class="docutils literal notranslate"><span class="pre">tutorials</span></code> directory).</p></li>
</ul>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tutorials/poststack.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Post Stack Inversion - 3D</p>
      </div>
    </a>
    <a class="right-next"
       href="contributing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Contributing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-operator">Creating the operator</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialization-init">Initialization (<code class="docutils literal notranslate"><span class="pre">__init__</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forward-mode-matvec">Forward mode (<code class="docutils literal notranslate"><span class="pre">_matvec</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjoint-mode-rmatvec">Adjoint mode (<code class="docutils literal notranslate"><span class="pre">_rmatvec</span></code>)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-the-operator">Testing the operator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#documenting-the-operator">Documenting the operator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-checklist">Final checklist</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, PyLops Development Team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>